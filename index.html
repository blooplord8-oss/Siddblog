<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Encrypted Blog</title>
<style>
body {
  background:#0b0f16;
  font-family:Arial;
  color:white;
  padding:20px;
}
.container {
  max-width:600px;
  margin:auto;
  background:#111827;
  padding:20px;
  border-radius:10px;
  box-shadow:0 0 20px rgba(0,0,0,0.5);
}
input, textarea {
  width:100%;
  padding:10px;
  margin-top:10px;
  border:none;
  border-radius:6px;
  background:#1f2937;
  color:white;
}
button {
  width:100%;
  padding:12px;
  margin-top:10px;
  background:#2563eb;
  border:none;
  color:white;
  font-weight:bold;
  border-radius:6px;
  cursor:pointer;
}
.post {
  background:#1f2937;
  padding:15px;
  border-radius:6px;
  margin-top:10px;
}
</style>
</head>
<body>

<div class="container" id="app">
  <h2>Secure Encrypted Blog</h2>

  <!-- LOGIN AREA -->
  <div id="loginBox">
    <p>Enter your master password:</p>
    <input type="password" id="masterPass" placeholder="Master Password">
    <button onclick="login()">Unlock</button>
  </div>

  <!-- EDITOR AREA -->
  <div id="editorBox" style="display:none;">
    <h3>Create Post</h3>
    <input type="text" id="title">
    <textarea id="content" rows="4"></textarea>
    <button onclick="savePost()">Save Encrypted</button>
  </div>

  <!-- POSTS -->
  <div id="posts"></div>
</div>

<script>
// ---- Helpers ----
const enc = new TextEncoder();
const dec = new TextDecoder();
let encryptionKey = null;

// Convert base64 to bytes
function b64ToBytes(b64){
  return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
}
// Convert bytes to base64
function bytesToB64(bytes){
  return btoa(String.fromCharCode(...new Uint8Array(bytes)));
}

// ---- Derive AES Key from Password ----
async function deriveKey(password){
  const baseKey = await crypto.subtle.importKey(
    "raw",
    enc.encode(password),
    {name:"PBKDF2"},
    false,
    ["deriveKey"]
  );

  return crypto.subtle.deriveKey(
    {
      name:"PBKDF2",
      salt: enc.encode("fixed-salt-123"), // keeps simple
      iterations: 200000,
      hash: "SHA-256"
    },
    baseKey,
    {name: "AES-GCM", length:256},
    false,
    ["encrypt","decrypt"]
  );
}

// ---- Encrypt ----
async function encryptText(text){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ciphertext = await crypto.subtle.encrypt(
    {name:"AES-GCM", iv},
    encryptionKey,
    enc.encode(text)
  );

  return {
    iv: bytesToB64(iv),
    data: bytesToB64(new Uint8Array(ciphertext))
  };
}

// ---- Decrypt ----
async function decryptText(obj){
  try {
    const iv = b64ToBytes(obj.iv);
    const data = b64ToBytes(obj.data);

    const plaintext = await crypto.subtle.decrypt(
      {name:"AES-GCM", iv},
      encryptionKey,
      data
    );
    return dec.decode(plaintext);
  } catch (e) {
    return null;
  }
}

// ---- Login ----
async function login(){
  const pass = document.getElementById("masterPass").value.trim();
  if (!pass) { alert("Enter password"); return; }

  encryptionKey = await deriveKey(pass);

  document.getElementById("loginBox").style.display = "none";
  document.getElementById("editorBox").style.display = "block";

  loadPosts();
}

// ---- Save Post ----
async function savePost(){
  const title = document.getElementById("title").value.trim();
  const content = document.getElementById("content").value.trim();
  if (!title || !content){
    alert("Enter both title and content");
    return;
  }

  const encrypted = await encryptText(JSON.stringify({title, content}));

  let posts = JSON.parse(localStorage.getItem("enc_posts")||"[]");
  posts.push(encrypted);

  localStorage.setItem("enc_posts", JSON.stringify(posts));

  document.getElementById("title").value = "";
  document.getElementById("content").value = "";

  loadPosts();
}

// ---- Load Posts ----
async function loadPosts(){
  const postsDiv = document.getElementById("posts");
  postsDiv.innerHTML = "";

  let posts = JSON.parse(localStorage.getItem("enc_posts")||"[]");

  for (let p of posts){
    let decrypted = await decryptText(p);
    if (!decrypted){
      postsDiv.innerHTML += `<div class="post">ðŸ”’ Encrypted (wrong password or corrupted)</div>`;
    } else {
      const obj = JSON.parse(decrypted);
      postsDiv.innerHTML += `
        <div class="post">
          <h3>${obj.title}</h3>
          <p>${obj.content}</p>
        </div>`;
    }
  }
}
</script>

</body>
</html>
